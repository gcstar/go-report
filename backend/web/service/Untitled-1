select a.dt,a.total_sales,b.total_people,c.kefu_sales,
round(b.total_people/d.uv,4) as store_rate,d.uv,round(e.zixun_num/d.uv,4) as callin_rate
,round(c.kefu_sales/a.total_sales,4) as kefu_sales_rate
,f.kefu_sales_num,e.zixun_num,
g.jiedai_num,h.avg_first_resp_time,'' as avg_resp_time,g.jiedai_people,
c.buycount 
 from
(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) dt,round(sum(b.buy_count * b.price),2) as total_sales
from ordercenter.tbl_order a,ordercenter.tbl_order_child b
where a.id=b.parent_order_id
and date(a.pay_time) = date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
) a join
(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) as dt,count(distinct transaction_id) as total_people
from ordercenter.tbl_order
where date(pay_time) = date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
) b on a.dt = b.dt join



(
select aa.dt,sum(mall_buycount+app_buycount) as buycount,sum(aa.kefu_sales_mall+bb.kefu_sales_app) as kefu_sales from
(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) as dt ,sum(buy_count) as mall_buycount, sum(buy_count*price) as kefu_sales_mall
from(
select a.user_id from
(
select distinct user_id  from xiaoneng.xn_chat_data where date(start_time) =date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
and user_id not like 'guest%'
) a  join
( select distinct transaction_id from ordercenter.tbl_order where date(pay_time) = date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
and source not in ('FlymePreApp','app','appflyme')
) b
on a.user_id = b.transaction_id
) c join ordercenter.tbl_order d on c.user_id = d.transaction_id
join ordercenter.tbl_order_child e on d.id = e.parent_order_id
 ) aa
left join
(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) as dt , sum(buy_count) as app_buycount,sum(buy_count*price) as kefu_sales_app
from(
select a.user_id from
(
select distinct user_id  from xiaoneng.xn_chat_data where date(start_time) =date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
and user_id not like 'guest%'
) a  join
(
 select distinct user_id as transaction_id from ordercenter.tbl_order
 where date(pay_time) = date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
and source in ('FlymePreApp','app','appflyme')
) b
on a.user_id = b.transaction_id
) c join ordercenter.tbl_order d on c.user_id = d.user_id
join ordercenter.tbl_order_child e on d.id = e.parent_order_id
 ) bb
on aa.dt = bb.dt
group by aa.dt

) c on b.dt =c.dt join


(
select aa.dt,(bb.uv+aa.uv) as uv from
(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) as dt,
count(distinct a.coid) as uv
from vdata.t_nginxlog_maidian a
where a.dt =  date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
) aa
join
(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) as dt,count(distinct b.im) as uv from
(
select a.im,a.suid
from vdata.t_click_mz_v1_in  a
where a.dt between date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) and date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-0)
and from_unixtime(int(substring(a.suid,1,10)),'yyyy-MM-dd')=date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)) b
) bb on aa.dt = bb.dt
) d on c.dt = d.dt join
(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) as dt,count(user_id) as zixun_num from xiaoneng.xn_chat_data
where date(start_time) =date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
) e on d.dt = e.dt join

(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) as dt,count(a.user_id) as kefu_sales_num from
(
select distinct user_id from xiaoneng.xn_chat_data where date(start_time) =date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
and user_id not like 'guest%'
) a  join
(
select distinct user_id as transaction_id from ordercenter.tbl_order where date(pay_time) = date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
union all
select distinct transaction_id from ordercenter.tbl_order where date(pay_time) = date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
) b
on a.user_id = b.transaction_id
) f on e.dt = f.dt join
(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) as dt ,count(user_id) as jiedai_num,
count(distinct user_id) as jiedai_people from xiaoneng.xn_chat_data
where date(start_time) =date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) and kf_msg_num>=1 and user_msg_num>=1
) g on f.dt = g.dt join
(
select date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1) as dt,
  round(avg(first_resp_time)/1000,2) as avg_first_resp_time from xiaoneng.xn_chat_data
where date(start_time) =date_add(from_unixtime(unix_timestamp(),'yyyy-MM-dd'),-1)
) h on g.dt = h.dt